<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Convert to cli errors • clipal</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Convert to cli errors">
<meta name="description" content='There have been many interfaces to raise errors with R over the years. A couple years ago, the tidyteam converged on using the cli package and began the cumbersome process of rewriting erroring code. This task is a difficult one to automate, as there are all sorts of weird edge cases and stylistic divergences; "every unhappy family is unhappy in its own way." This RStudio add-in helps you convert your R code to use the cli package for error messages using LLMs.'>
<meta property="og:description" content='There have been many interfaces to raise errors with R over the years. A couple years ago, the tidyteam converged on using the cli package and began the cumbersome process of rewriting erroring code. This task is a difficult one to automate, as there are all sorts of weird edge cases and stylistic divergences; "every unhappy family is unhappy in its own way." This RStudio add-in helps you convert your R code to use the cli package for error messages using LLMs.'>
<meta property="og:image" content="https://simonpcouch.github.io/clipal/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">clipal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/simonpcouch/clipal/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="your-cli-pal-">Your cli pal <a class="anchor" aria-label="anchor" href="#your-cli-pal-"></a>
</h1>
</div>
<!-- badges: start -->

<p>A couple years ago, the tidyverse team began migrating to the cli R package for raising errors, transitioning away from base R (e.g. <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code>), rlang (e.g. <code><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">rlang::abort()</a></code>), glue, and homegrown combinations of them. cli’s new syntax is easier to work with as a developer and more visually pleasing as a user.</p>
<p>In some cases, transitioning is as simple as Finding + Replacing <code><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">rlang::abort()</a></code> to <code><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli::cli_abort()</a></code>. In others, there’s a mess of ad-hoc pluralization, <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code>s, glue interpolations, and other assorted nonsense to sort through. Total pain, especially with thousands upon thousands of error messages thrown across the tidyverse, r-lib, and tidymodels organizations.</p>
<p>clipal (“c-l-i pal”) is an RStudio add-in that helps you convert your R package to use cli for error messages. It’s vaguely correct most of the time, and greatly speeds up the process for converting error messages to cli, in my experience.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install clipal like so:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"simonpcouch/clipal"</span><span class="op">)</span></span></code></pre></div>
<p>Then,</p>
<ul>
<li>Ensure that you have an <code>ANTHROPIC_API_KEY</code> set in your <a href="https://github.com/gaborcsardi/dotenv" class="external-link"><code>.env</code></a>. If you’d like to use an LLM other than Anthropic’s Claude 3.5 Sonnet to power the cli pal, see <code>?cli_pal()</code> to set default metadata on that model.</li>
<li>Assign the “Convert to cli” addin the shortcut “Ctrl+Shift+C”. (See instructions below if needed!)</li>
</ul>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>The package provides an RStudio add-in “Convert to cli” that we suggest registering with the keybinding “Ctrl+Shift+C”. To do so, navigate to Tools &gt; Modify Keyboard Shortcuts &gt; Search “Convert to cli”, and add the keybinding. After selecting some code, press the keyboard shortcut and wait a moment:</p>
<p><img src="inst/figs/addin.gif"></p>
<p>See the <a href="#gallery">Gallery</a> for more a varied set of examples.</p>
</div>
<div class="section level2">
<h2 id="cost">Cost<a class="anchor" aria-label="anchor" href="#cost"></a>
</h2>
<p>The system prompt from a cli pal includes something like 4,000 tokens. Add in (a generous) 100 tokens for the code that’s actually highlighted and also sent off to the model and you’re looking at 4,100 input tokens. The model returns approximately the same number of output tokens as it receives, so we’ll call that 100 output tokens per refactor.</p>
<p>As of the time of writing (October 2024), the default clipal model Claude Sonnet 3.5 costs $3 per million input tokens and $15 per million output tokens. So, using the default model, <strong>cli pals cost around $15 for every 1,000 refactored pieces of code</strong>. GPT-4o Mini, by contrast, doesn’t tend to get cli markup classes right but <em>does</em> return syntactically valid calls to cli functions, and it would cost around 75 cents per 1,000 refactored pieces of code.</p>
</div>
<div class="section level2">
<h2 id="gallery">Gallery<a class="anchor" aria-label="anchor" href="#gallery"></a>
</h2>
<p>This section include a handful of examples <a href="https://github.com/tidymodels/tune/blob/f8d734ac0fa981fae3a87ed2871a46e9c40d509d/R/checks.R" class="external-link">“from the wild”</a> and are generated with the default model, Claude Sonnet 3.5.</p>
<p>The <code><a href="reference/cli_pal.html">cli_pal()</a></code> function instantiates a cli pal and is a light wrapper around functions creating <a href="https://github.com/hadley/elmer" class="external-link">elmer</a> chats.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/simonpcouch/clipal" class="external-link">clipal</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/cli_pal.html">cli_pal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── A claude-3-5-sonnet-20240620-based cli pal.</span></span></code></pre></div>
<p>The <code><a href="reference/convert_to_cli.html">convert_to_cli()</a></code> function takes an R expression that raises a condition and converts it to use cli. At its simplest, a one-line message with a little bit of markup:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`save_pred` can only be used if the initial results saved predictions."</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort("`save_pred` can only be used if the initial results saved predictions.")</span></span></code></pre></div>
<p>The function knows to look for the most recently defined cli pal, but you can pass one manually via <code>convert_to_cli(cli_pal)</code> if you please.</p>
<p>Some strange vector collapsing and funky line breaking:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">extra_grid_params</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/quoting.html" class="external-link">single_quote</a></span><span class="op">(</span><span class="va">extra_grid_params</span><span class="op">)</span></span>
<span>  <span class="va">extra_grid_params</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_collapse.html" class="external-link">glue_collapse</a></span><span class="op">(</span><span class="va">extra_grid_params</span>, sep <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span></span>
<span>    <span class="st">"The provided `grid` has the following parameter columns that have "</span>,</span>
<span>    <span class="st">"not been marked for tuning by `tune()`: {extra_grid_params}."</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort(</span></span>
<span><span class="co">#&gt;   "The provided {.arg grid} has the parameter column{?s} </span></span>
<span><span class="co">#&gt;    {.val {extra_grid_params}} that {?has/have} not been marked for tuning </span></span>
<span><span class="co">#&gt;    by {.fn tune}."</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>A message that probably best lives as two separate elements:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>      <span class="st">"Some model parameters require finalization but there are recipe"</span>,</span>
<span>      <span class="st">"parameters that require tuning. Please use "</span>,</span>
<span>      <span class="st">"`extract_parameter_set_dials()` to set parameter ranges "</span>,</span>
<span>      <span class="st">"manually and supply the output to the `param_info` argument."</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort(</span></span>
<span><span class="co">#&gt;   c(</span></span>
<span><span class="co">#&gt;     "Some model parameters require finalization but there are recipe</span></span>
<span><span class="co">#&gt;      parameters that require tuning.",</span></span>
<span><span class="co">#&gt;     "i" = "Please use {.fn extract_parameter_set_dials} to set parameter</span></span>
<span><span class="co">#&gt;            ranges manually and supply the output to the {.arg param_info}</span></span>
<span><span class="co">#&gt;            argument."</span></span>
<span><span class="co">#&gt;   )</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>Gnarly ad-hoc pluralization:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">msg</span> <span class="op">&lt;-</span> <span class="st">"Creating pre-processing data to finalize unknown parameter"</span></span>
<span>  <span class="va">unk_names</span> <span class="op">&lt;-</span> <span class="va">pset</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">unk</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unk_names</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">msg</span>, <span class="st">": "</span>, <span class="va">unk_names</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">msg</span>, <span class="st">"s: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"'"</span>, <span class="va">unk_names</span>, <span class="st">"'"</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">inform</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_inform(</span></span>
<span><span class="co">#&gt;   "Creating pre-processing data to finalize unknown parameter{?s}: {unk_names}"</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>Some <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code> wonk:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"The workflow has arguments to be tuned that are missing some "</span>,</span>
<span>    <span class="st">"parameter objects: "</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"'"</span>, <span class="va">pset</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="op">!</span><span class="va">params</span><span class="op">]</span>, <span class="st">"'"</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort(</span></span>
<span><span class="co">#&gt;   "The workflow has arguments to be tuned that are missing some </span></span>
<span><span class="co">#&gt;    parameter objects: {.val {pset$id[!params]}}"</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>The model is instructed to only return a call to a cli function, so erroring code that’s run conditionally can get borked:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">cls</span>, collapse <span class="op">=</span> <span class="st">" or "</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">fine</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Argument '{deparse(cl$x)}' should be a {cls} or NULL"</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">where</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="va">msg</span>, <span class="st">" in `{where}`"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort(</span></span>
<span><span class="co">#&gt;   "Argument {.code {deparse(cl$x)}} should be {?a/an} {cls} or NULL{?in {where}}."</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>Sprintf-style statements aren’t an issue:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/convert_to_cli.html">convert_to_cli</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">abort</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"No such '%s' function: `%s()`."</span>, <span class="va">package</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; cli::cli_abort("No such {.pkg {package}} function: {.fn {name}}.")</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/simonpcouch/clipal/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/simonpcouch/clipal/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
<li><a href="SUPPORT.html">Getting help</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing clipal</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Simon Couch <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-5676-5107" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
<li><a href="https://CRAN.R-project.org/package=clipal" class="external-link"><img src="https://www.r-pkg.org/badges/version/clipal" alt="CRAN status"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Simon Couch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
